<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
</head>
<body>
<table>
    <tr>
        <th>USD/BYN</th>
        <th>EUR/BYN</th>
        <th>BYN/PLN</th>
        <th>UPDATE</th>
        <th>ON DATE</th>
    </tr>
    <tr>
        <th><p id="print-BSB-USD"></p></th>
        <th><p id="print-BSB-EUR"></p></th>
        <th><p id="print-BSB-PLN"></p></th>
        <th><button onclick="requestPostBSB()">update</button></th>
        <th><p id="print-BSB-TS"></p></th>
    </tr>
</table>

<div><p id="printBNB"></p> <button onclick="requestPostBNB()">update</button></div>
<div><p id="printAlfa"></p> <button onclick="requestPostAlfa()">update</button></div>

<script>
function requestPostBSB () {
    let urlBsb = 'https://mobile.bsb.by/api/v1/free-zone-management/exchange-rates/rates';
    console.log('URL for POST:', urlBsb);
    let nowDate = Date.parse(new Date());

    fetch(urlBsb,{
            body: JSON.stringify({
                'period': nowDate,
                'type': 'CARD'
            }),
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json',
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36'
            },
            method: 'POST',
            redirect: 'follow'
        })
        .then(response => {
                response.json() 
                .then(res => {
                    console.log(res.rates)

                    let rates = res['rates'];

                    let rateUSD = rates[0].sellAmount.toFixed(4);
                    let rateEUR = rates[1].sellAmount.toFixed(4);
                    let ratePLN = (1 / rates[6].sellAmount).toFixed(4);

                    document.getElementById("print-BSB-USD").innerText = rateUSD;
                    document.getElementById("print-BSB-EUR").innerText = rateEUR;
                    document.getElementById("print-BSB-PLN").innerText = ratePLN;
                    document.getElementById("print-BSB-TS").innerText = new Date().toLocaleString();
                })
            ;
        })
        .catch(error => {
        console.error(error);
        });
}

function requestPostBNB () {
    var urlBNB = 'https://corsproxy.io/?https://bnb.by/kursy-valyut/imbank/';
    console.log('URL for POST:', urlBNB);

    let printBNB = document.getElementById("printBNB");

    fetch(urlBNB, {   
            headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36',
            }
        })
        .then(response => {
            //console.log(response);
            response.text()
            .then(res => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(res, "text/html");
                console.log(doc);

                let rates = JSON.parse(doc.querySelector('input.jsConfig').value);

                let rateUSD = rates['USD']['BYN']['SALE'];
                let rateEUR = rates['EUR']['BYN']['SALE'];
                let ratePLN = rates['PLN']['BYN']['SALE'];

                let rateText = "BNB: " + rateUSD + " USD"  +
                    " | " + rateEUR + " EUR" +
                    " | " + ratePLN + " PLN";
                printBNB.innerText = rateText;
            })
        })
        .catch(error => {
        console.error(error);
        });
}

function requestPostAlfa (urlAlfa)
{
    const myArticle = document.querySelector("article");
    console.log('URL for POST:', urlAlfa);
    
    fetch(urlAlfa, {   
            cors: 'no-cors',
            headers:  {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36',
            } 
        })
        .then(response => {
            //console.log(response);
            response.text()
            .then(res => {
                //console.log("Alfa: ", res);
                const parser = new DOMParser();
                const doc = parser.parseFromString(res, "text/html");
                //console.log("Alfa: ", doc);
                //const obj = JSON.parse(doc.querySelectorAll("div"));
                const obj = doc.querySelectorAll("div");
                console.log(obj);
                // const obj = JSON.parse(doc.querySelectorAll("input")[4].value);

                // var bnbElement = document.createElement("bnb");
                // bnbElement.textContent = (
                //     "BNB: " + obj.USD.BYN.SALE + " USD"  + 
                //     " | " + obj.EUR.BYN.SALE + " EUR" + 
                //     " | " + obj.PLN.BYN.SALE + " PLN");
                // printBNB.appendChild(bnbElement)
            })
        })
        .catch(error => {
        console.error(error);
        });
    
}

function getExchangeRates(){
    // var urlAlfa = 'https://api.codetabs.com/v1/proxy?quest=https://www.alfabank.by/exchange/digital/';
    requestPostBSB();
    requestPostBNB();
    //requestPostAlfa(urlAlfa);
}

window.onload = (event) => {
    console.log('onload')
    getExchangeRates();
};
</script>
</body>
</html>